<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
    <title>文档列表</title>
    <style>
        html {
            color: #0f0f0f;
            background-color: #fff;
            font-size: 10px;
            font-family: Roboto, Arial, sans-serif
        }

        body {
            margin: 0;
            padding: 0;
            padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            font-size: 1.2rem;
            overflow-x: hidden
        }

        input,
        textarea {
            background-color: transparent;
            padding-bottom: 4px;
            outline: none;
            box-sizing: border-box;
            border: none;
            border-radius: 0;
            margin-bottom: 1px;
            font: inherit;
            color: #0f0f0f
        }

        input::-webkit-input-placeholder,
        textarea::-webkit-input-placeholder {
            color: #606060;
            opacity: 1
        }

        input::placeholder,
        textarea::placeholder {
            color: #606060;
            opacity: 1
        }

        textarea {
            -webkit-appearance: none;
            appearance: none;
            min-height: 8.4rem;
            width: 100%;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 8px
        }

        input {
            border-bottom: 1px solid #737373;
            text-overflow: ellipsis
        }

        input:focus {
            margin-bottom: 0;
            border-bottom-width: 2px;
            border-bottom-color: #0f0f0f
        }

        html,
        body {
            height: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
        }

        textarea {
            flex-grow: 1;
            resize: none;
            font-size: 18px;
        }

        textarea:focus {
            outline: none;
        }

        .bar-renderer {
            display: flex;
            justify-content: space-around;
            padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            height: 48px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: #0f0f0f;
            font-size: 1.1rem;
            background: #fff;

        }

        .bar-item-renderer {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            flex: 1 1 0;
        }

        .bar-item-renderer > svg {
            width: 24px;
            height: 24px;
        }

        .bar-item-title {

            max-width: 100%;
            padding: 0 4px;
            box-sizing: border-box;
            display: block;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            color: #0f0f0f;

        }

        .dialog-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            -webkit-box-align: center;
            align-items: center;
            -webkit-box-pack: center;
            justify-content: center;
            z-index: 4;
            margin: 0 40px;
            padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .dialog {
            position: relative;
            z-index: 2;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            flex-direction: column;
            max-height: 100%;
            box-sizing: border-box;
            padding: 16px;
            margin: 0 auto;
            overflow-x: hidden;
            overflow-y: auto;
            font-size: 1.3rem;
            color: #0f0f0f;
            border: none;
            min-width: 250px;
            max-width: 356px;
            box-shadow: 0 0 24px 12px rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            background-color: #fff;
        }

        .dialog-header {
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            flex-direction: column;
            flex-shrink: 0;
        }

        .dialog-header-title {
            margin: 0 0 3px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            max-height: 2.5em;
            -webkit-line-clamp: 2;
            overflow: hidden;
            line-height: 1.25;
            text-overflow: ellipsis;
            font-weight: normal;
            font-size: 1.8rem;
        }

        .dialog-body {
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 100vh;
            white-space: pre-wrap;
        }

        .dialog-buttons {
            flex-shrink: 0;
            display: flex;
            -webkit-box-align: center;
            align-items: center;
            -webkit-box-pack: end;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .dialog-button {
            outline: none;
            font: inherit;
            position: relative;
            margin: 0;
            white-space: nowrap;
            min-width: 0;
            text-transform: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            outline-width: 0;
            box-sizing: border-box;
            background: none;
            text-decoration: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-box-flex: 1;
            flex: 1;
            flex-basis: 0.000000001px;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-box-direction: normal;
            flex-direction: row;
            -webkit-box-align: center;
            align-items: center;
            -webkit-box-pack: center;
            justify-content: center;
            padding: 0 16px;
            height: 36px;
            font-size: 14px;
            line-height: 36px;
            border-radius: 18px;
            color: #0f0f0f;
        }

        .modern-overlay {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .dialog-item {
            border-top: 1px solid #dadce0;
            padding: 8px 0;
            min-height: 43px;
            box-sizing: border-box;
            display: flex;
            -webkit-box-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            align-items: center;
        }

        .dialog-item-title {
            display: flex;
            -webkit-box-align: center;
            align-items: center;
            letter-spacing: .07272727em;
            font-family: Roboto, Arial, sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            line-height: 6.875px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .dialog-item-icon {
            width: 24px;
            height: 24px;
            display: flex;
            color: rgb(218, 220, 224)
        }

        .dialog-item-svg {
            width: 24px;
            height: 24px;
            display: block;
            fill: currentcolor
        }

        .dialog-body::-webkit-scrollbar {
            display: none;
        }

        .dialog-search {
            flex-shrink: 0;
            background: #fff;
            outline: none;
            border-radius: 30px;
            /*box-shadow: 0 1px 3px rgba(60, 63, 66, .32), 0 4px 12px rgba(60, 63, 66, .15);*/
            height: 60px;
            padding-left: 54px;
            position: relative;
        }

        .dialog-search-input {
            display: flex;
            flex: 1;
            position: relative;
            background-color: transparent;
            font: inherit;
            height: 100%;
            color: #202124;
            -webkit-text-fill-color: #202124;
            font-size: 16px;
            line-height: 24px;
            opacity: 1;
            padding: 0;
            margin: 0;
            border: none;
            outline: none;
            padding-right: 0;
        }</style>
</head>

<body>
<div class="bar-renderer">
    <div id="translate-english" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path
                    d="M21.516 20.484v-13.969q0-0.422-0.305-0.727t-0.727-0.305h-9.047l1.313 3.797h1.453v-1.266h1.266v1.266h4.547v1.313h-1.922q-0.703 2.344-2.391 4.219l3.281 3.281-0.938 0.891-3.094-3.094 1.031 3.094-1.969 2.531h6.469q0.422 0 0.727-0.305t0.305-0.727zM13.172 10.594l0.797 2.344 0.844 1.125q1.453-1.594 2.063-3.469h-3.703zM6.984 15.984q2.156 0 3.492-1.359t1.336-3.516q0-0.047-0.141-1.031h-4.688v1.734h2.953q-0.094 0.891-0.844 1.641t-2.109 0.75q-1.313 0-2.227-0.938t-0.914-2.25q0-1.359 0.914-2.297t2.227-0.938q1.266 0 2.063 0.797l1.313-1.266q-1.453-1.313-3.375-1.313-2.063 0-3.516 1.477t-1.453 3.539 1.453 3.516 3.516 1.453zM21 3.984q0.797 0 1.406 0.609t0.609 1.406v15q0 0.797-0.609 1.406t-1.406 0.609h-9l-0.984-3h-8.016q-0.797 0-1.406-0.609t-0.609-1.406v-15q0-0.797 0.609-1.406t1.406-0.609h6.984l1.031 3h9.984z">
            </path>
        </svg>
        <div class="bar-item-title">
            翻译英文
        </div>
    </div>
    <div id="format-code-block" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M14.578 16.594l4.641-4.594-4.641-4.594 1.406-1.406 6 6-6 6zM9.422 16.594l-1.406 1.406-6-6 6-6 1.406 1.406-4.641 4.594z"></path>
        </svg>
        <div class="bar-item-title">
            代码块
        </div>
    </div>


    <div id="format-head" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M5.016 3.984h13.969v3h-5.484v12h-3v-12h-5.484v-3z"></path>
        </svg>
        <div class="bar-item-title">
            标题
        </div>
    </div>
    <div id="format-cut-before" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M18.984 3h3v0.984l-6.984 7.031-2.016-2.016zM12 12.516q0.516 0 0.516-0.516t-0.516-0.516-0.516 0.516 0.516 0.516zM6 20.016q0.797 0 1.406-0.586t0.609-1.43-0.609-1.43-1.406-0.586-1.406 0.586-0.609 1.43 0.609 1.43 1.406 0.586zM6 8.016q0.797 0 1.406-0.586t0.609-1.43-0.609-1.43-1.406-0.586-1.406 0.586-0.609 1.43 0.609 1.43 1.406 0.586zM9.656 7.641l12.328 12.375v0.984h-3l-6.984-6.984-2.344 2.344q0.328 0.703 0.328 1.641 0 1.641-1.172 2.813t-2.813 1.172-2.813-1.172-1.172-2.813 1.172-2.813 2.813-1.172q0.938 0 1.641 0.328l2.344-2.344-2.344-2.344q-0.703 0.328-1.641 0.328-1.641 0-2.813-1.172t-1.172-2.813 1.172-2.813 2.813-1.172 2.813 1.172 1.172 2.813q0 0.938-0.328 1.641z"></path>
        </svg>
        <div class="bar-item-title">
            剪切前
        </div>
    </div>
    <div id="format-paste-end" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M18.984 20.016v-16.031h-1.969v3h-10.031v-3h-1.969v16.031h13.969zM12 2.016q-0.422 0-0.703 0.281t-0.281 0.703 0.281 0.703 0.703 0.281 0.703-0.281 0.281-0.703-0.281-0.703-0.703-0.281zM18.984 2.016q0.797 0 1.406 0.586t0.609 1.383v16.031q0 0.797-0.609 1.383t-1.406 0.586h-13.969q-0.797 0-1.406-0.586t-0.609-1.383v-16.031q0-0.797 0.609-1.383t1.406-0.586h4.172q0.328-0.891 1.078-1.453t1.734-0.563 1.734 0.563 1.078 1.453h4.172z"></path>
        </svg>
        <div class="bar-item-title">
            粘贴后
        </div>
    </div>
    <div id="format-upload" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M8.484 13.5l-3.469 4.5h13.969l-4.5-6-3.469 4.5zM21 18.984q0 0.797-0.609 1.406t-1.406 0.609h-13.969q-0.797 0-1.406-0.609t-0.609-1.406v-13.969q0-0.797 0.609-1.406t1.406-0.609h13.969q0.797 0 1.406 0.609t0.609 1.406v13.969z"></path>
        </svg>
        <div class="bar-item-title">
            上传
        </div>
    </div>
    <div id="show-patterns" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path
                    d="M20.016 2.016h-16.031q-0.797 0-1.383 0.586t-0.586 1.383v18l3.984-3.984h14.016q0.797 0 1.383-0.586t0.586-1.43v-12q0-0.797-0.586-1.383t-1.383-0.586zM18.984 12.984l-2.484-1.5-2.484 1.5v-7.969h4.969v7.969z">
            </path>
        </svg>
        <div class="bar-item-title">
            模式
        </div>
    </div>

    <div id="show-snippet" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path
                    d="M20.016 2.016h-16.031q-0.797 0-1.383 0.586t-0.586 1.383v18l3.984-3.984h14.016q0.797 0 1.383-0.586t0.586-1.43v-12q0-0.797-0.586-1.383t-1.383-0.586zM18.984 12.984l-2.484-1.5-2.484 1.5v-7.969h4.969v7.969z">
            </path>
        </svg>
        <div class="bar-item-title">
            代码段
        </div>
    </div>
    <div id="show-note" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M3 12.984v-1.969h18v1.969h-18zM3 6h18v2.016h-18v-2.016zM3 18v-2.016h12v2.016h-12z"></path>
        </svg>
        <div class="bar-item-title">
            笔记
        </div>
    </div>
</div>

<textarea id="textarea"></textarea>
<div class="bar-renderer">
    <div id="translate-chinese" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path
                    d="M21.516 20.484v-13.969q0-0.422-0.305-0.727t-0.727-0.305h-9.047l1.313 3.797h1.453v-1.266h1.266v1.266h4.547v1.313h-1.922q-0.703 2.344-2.391 4.219l3.281 3.281-0.938 0.891-3.094-3.094 1.031 3.094-1.969 2.531h6.469q0.422 0 0.727-0.305t0.305-0.727zM13.172 10.594l0.797 2.344 0.844 1.125q1.453-1.594 2.063-3.469h-3.703zM6.984 15.984q2.156 0 3.492-1.359t1.336-3.516q0-0.047-0.141-1.031h-4.688v1.734h2.953q-0.094 0.891-0.844 1.641t-2.109 0.75q-1.313 0-2.227-0.938t-0.914-2.25q0-1.359 0.914-2.297t2.227-0.938q1.266 0 2.063 0.797l1.313-1.266q-1.453-1.313-3.375-1.313-2.063 0-3.516 1.477t-1.453 3.539 1.453 3.516 3.516 1.453zM21 3.984q0.797 0 1.406 0.609t0.609 1.406v15q0 0.797-0.609 1.406t-1.406 0.609h-9l-0.984-3h-8.016q-0.797 0-1.406-0.609t-0.609-1.406v-15q0-0.797 0.609-1.406t1.406-0.609h6.984l1.031 3h9.984z">
            </path>
        </svg>
        <div class="bar-item-title">
            翻译中文
        </div>
    </div>
    <div id="delete-line" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z"></path>

        </svg>
        <div class="bar-item-title">
            删除行
        </div>
    </div>
    <div id="format-save" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M15 9v-3.984h-9.984v3.984h9.984zM12 18.984q1.219 0 2.109-0.891t0.891-2.109-0.891-2.109-2.109-0.891-2.109 0.891-0.891 2.109 0.891 2.109 2.109 0.891zM17.016 3l3.984 3.984v12q0 0.797-0.609 1.406t-1.406 0.609h-13.969q-0.844 0-1.43-0.586t-0.586-1.43v-13.969q0-0.844 0.586-1.43t1.43-0.586h12z"></path>
        </svg>
        <div class="bar-item-title">
            保存
        </div>
    </div>
    <div id="format-code" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M14.578 16.594l4.641-4.594-4.641-4.594 1.406-1.406 6 6-6 6zM9.422 16.594l-1.406 1.406-6-6 6-6 1.406 1.406-4.641 4.594z"></path>
        </svg>
        <div class="bar-item-title">
            代码
        </div>
    </div>
    <div id="format-bold" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M13.5 15.516q0.656 0 1.078-0.445t0.422-1.055-0.422-1.055-1.078-0.445h-3.516v3h3.516zM9.984 6.516v3h3q0.609 0 1.055-0.445t0.445-1.055-0.445-1.055-1.055-0.445h-3zM15.609 10.781q2.156 0.984 2.156 3.422 0 1.594-1.055 2.695t-2.648 1.102h-7.078v-14.016h6.281q1.688 0 2.836 1.172t1.148 2.859-1.641 2.766z"></path>
        </svg>
        <div class="bar-item-title">
            粗体
        </div>
    </div>
    <div id="format-indent-increase" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path d="M11.016 12.984v-1.969h9.984v1.969h-9.984zM11.016 9v-2.016h9.984v2.016h-9.984zM3 3h18v2.016h-18v-2.016zM11.016 17.016v-2.016h9.984v2.016h-9.984zM3 8.016l3.984 3.984-3.984 3.984v-7.969zM3 21v-2.016h18v2.016h-18z"></path>
        </svg>
        <div class="bar-item-title">
            缩进
        </div>
    </div>
    <div id="format-comment" class="bar-item-renderer">
        <svg viewBox="0 0 24 24">
            <path
                    d="M20.016 2.016h-16.031q-0.797 0-1.383 0.586t-0.586 1.383v18l3.984-3.984h14.016q0.797 0 1.383-0.586t0.586-1.43v-12q0-0.797-0.586-1.383t-1.383-0.586zM18.984 12.984l-2.484-1.5-2.484 1.5v-7.969h4.969v7.969z">
            </path>
        </svg>
        <div class="bar-item-title">
            评论
        </div>
    </div>
</div>
<script type="module">
    import init, {start} from "./notes.js";

    init().then(() => {
        start("")
    });
</script>
<script>
    /*
绑定元素和事件
例如：<div bind="div" @click="click"></div>
执行下列代码后，即可通过 this.div 访问该元素
在全局下编写click函数，即可自动绑定到该元素的click事件
*/
    function bind(elememnt) {
        (elememnt || document).querySelectorAll('[bind]').forEach(element => {
            if (element.getAttribute('bind')) {
                window[element.getAttribute('bind')] = element;
            }
            [...element.attributes].filter(attr => attr.nodeName.startsWith('@')).forEach(attr => {
                if (!attr.value) return;
                element.addEventListener(attr.nodeName.slice(1), evt => {
                    if (window[attr.value])
                        window[attr.value](evt);
                    else {
                        window['actions'][attr.value](evt);
                    }
                });
            });
        })
    }

    function camel(string) {
        return string.replaceAll(/[ _-]([a-zA-Z])/g, m => m[1].toUpperCase());
    }

    function substring(strings, prefix, suffix) {
        let start = strings.indexOf(prefix);
        if (start === -1) {
            return [0, 0]
        }
        start += prefix.length;
        let end = strings.indexOf(suffix, start);
        if (end === -1) {
            return [0, 0]
        }
        return [start, end]
    }

    function substringAfter(string, delimiter, missingDelimiterValue) {
        const index = string.indexOf(delimiter);
        if (index === -1) {
            return missingDelimiterValue || string;
        } else {
            return string.substring(index + delimiter.length);
        }
    }

    function substringAfterLast(string, delimiter, missingDelimiterValue) {
        const index = string.lastIndexOf(delimiter);
        if (index === -1) {
            return missingDelimiterValue || string;
        } else {
            return string.substring(index + delimiter.length);
        }
    }

    function substringBefore(string, delimiter, missingDelimiterValue) {
        const index = string.indexOf(delimiter);
        if (index === -1) {
            return missingDelimiterValue || string;
        } else {
            return string.substring(0, index);
        }
    }

    function substringBeforeLast(string, delimiter, missingDelimiterValue) {
        const index = string.lastIndexOf(delimiter);
        if (index === -1) {
            return missingDelimiterValue || string;
        } else {
            return string.substring(0, index);
        }
    }

    function substringNearest(string, index, start, end) {
        let j = index;
        while (j > -1) {
            if (start.indexOf(string[j]) !== -1) {
                j++
                break;
            }
            j--;
        }
        let k = index;
        while (k < string.length) {
            if (end.indexOf(string[k]) !== -1) {
                break;
            }
            k++;
        }
        return string.substring(j, k);
    }

    function upperCamel(string) {
        string = camel(string);
        return string.slice(0, 1).toUpperCase() + string.slice(1);
    }

    function writeText(message) {
        const textarea = document.createElement("textarea");
        textarea.style.position = 'fixed';
        textarea.style.right = '100%';
        document.body.appendChild(textarea);
        textarea.value = message;
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
    }

    function snake(string) {
        return string.replaceAll(/(?<=[a-z])[A-Z]/g, m => `_${m}`).toLowerCase()
            .replaceAll(/[ -]([a-z])/g, m => `_${m[1]}`)
    }

    function humanFileSize(size) {
        if (size === 0) return '0';
        var i = Math.floor(Math.log(size) / Math.log(1024));
        return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'kB', 'MB', 'GB', 'TB'][i]
    }

    async function readText() {
        // const textarea = document.createElement("textarea");
        // textarea.style.position = 'fixed';
        // textarea.style.right = '100%';
        // document.body.appendChild(textarea);
        // textarea.value = message;
        // textarea.select();
        // document.execCommand('paste');
        // return textarea.value;
        let strings;
        if (typeof NativeAndroid !== 'undefined') {
            strings = NativeAndroid.readText()
        } else {
            strings = await navigator.clipboard.readText()
        }
        return strings
    }


</script>
<script>
    function cutBefore() {
        const before = textarea.value.substring(0, textarea.selectionStart);
        writeText(before);
        textarea.value = textarea.value.substring(textarea.selectionStart);
    }

    async function pasteEnd() {
        textarea.value = textarea.value.trim() +
            (await readText())
    }

    function tryUploadImageFromClipboard(success, error) {
        navigator.permissions.query({
            name: "clipboard-read"
        }).then(result => {
            console.log(result);
            if (result.state === "granted" || result.state === "prompt") {
                navigator.clipboard.read().then(data => {
                    console.log(data[0].types);
                    const blob = data[0].getType("image/png");
                    console.log(blob.then(res => {
                        const formData = new FormData();
                        formData.append("images", res, "1.png");
                        fetch(`https://lucidu.cn/v1/picture`, {
                            method: "POST", body: formData
                        }).then(res => {
                            return res.text();
                        }).then(obj => {
                            success(obj);
                        })
                    }).catch(err => {
                        console.log(err)
                        error(err);
                    }))
                })
                    .catch(err => {
                        console.log(err)
                        error(err);
                    });
            } else {
                console.log("Error")
                error(new Error());
            }
        });
    }

    async function uploadImage(image, name) {
        const form = new FormData();
        form.append('images', image, name)
        const response = await fetch(`https://lucidu.cn/v1/picture`, {
            method: 'POST', body: form
        });
        return await response.text();
    }

    function uploadHanlder(editor) {
        tryUploadImageFromClipboard((ok) => {
            const string = `![](https://static.lucidu.cn/images/${ok})\n\n`;
            editor.setRangeText(string, editor.selectionStart, editor.selectionStart);
        }, () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.addEventListener('change', async ev => {
                const file = input.files[0];
                const imageFile = await uploadImage(file, file.name);
                const string = `![](https://static.lucidu.cn/images/${imageFile})\n\n`;
                editor.setRangeText(string, editor.selectionStart, editor.selectionStart);
            });
            input.click();
        });
    }

    function findCodeBlockExtend(textarea) {
        const value = textarea.value;
        let start = textarea.selectionStart;
        let end = textarea.selectionEnd;
        while (start > -1) {
            if (value[start] === '`' && value[start - 1] === '`' && value[start - 2] === '`') {
                // start += 1;
                start -= 2;
                while (start - 1 > 0 && value[start - 1] !== '\n') {
                    start--;
                }
                break;
            }
            start--;
        }
        while (end < value.length) {
            if (value[end] === '`' && value[end + 1] === '`' && value[end + 2] === '`') {
                end += 2;
                break;
            }
            end++;
        }
        return [start, end];
    }

    const textarea = document.getElementById('textarea');
    document.addEventListener('keydown', async ev => {
        if (ev.altKey) {
            if (ev.key === 'q') {
                const strings = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
                if (!strings) {
                    return;
                }
                fetch(`/api/snippet/insert`, {
                    method: 'post',
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },
                    body: JSON.stringify({
                        "prefix": substringBefore(strings, "\n").trim(),
                        "body": substringAfter(strings, "\n").trim()
                    })
                })

            } else if (ev.key === 'w') {
                if (textarea.selectionStart !== textarea.selectionEnd) {
                    let str = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
                    const firstLine = substringBefore(str, " ");
                    str = substringAfter(str, " ").trim();
                    const secondLine = substringBefore(str, " ");
                    str = substringAfter(str, " ").trim();
                    textarea.setRangeText(str.replaceAll(new RegExp(firstLine, 'g'), secondLine)
                            .replaceAll(new RegExp(upperCamel(firstLine), 'g'), upperCamel(secondLine)),
                        textarea.selectionStart, textarea.selectionEnd, 'end')
                } else {
                    const founded = textarea.value.indexOf("```") !== -1;
                    if (founded) {
                        const pv = findCodeBlockExtend(textarea);
                        let str = textarea.value.substring(pv[0] + 3, pv[1] - 3).trim();
                        const firstLine = substringBefore(str, "\n");
                        str = substringAfter(str, "\n");
                        const secondLine = substringBefore(str, "\n");
                        str = substringAfter(str, "\n").trim();

                        textarea.setRangeText(str.replaceAll(new RegExp(firstLine, 'g'), secondLine), pv[0], pv[1] + 1, "end");
                    } else {

                        let str = textarea.value;
                        const firstLine = substringBefore(str, "\n");
                        str = substringAfter(str, "\n");
                        const secondLine = substringBefore(str, "\n");
                        str = substringAfter(str, "\n").trim();
                        textarea.value = firstLine + "\n" + secondLine + "\n" + str.replaceAll(new RegExp(firstLine, 'g'), secondLine)
                            .replaceAll(new RegExp(upperCamel(firstLine), 'g'), upperCamel(secondLine));
                    }
                }

            }
        }
        // console.log(ev.key)  || ev.keyCode == 229
        if (ev.key === ' ') {

            let start = textarea.selectionStart;
            let end = start;
            if (start > -1)
                start--;
            while (start > -1 && /[a-zA-Z0-9]+/.test(textarea.value[start])) {
                start--;
            }
            start++;
            const key = textarea.value.substring(start, end).trim();
            if (!key) {
                return;
            }
            let value;
            try {
                let res = await fetch(`/api/snippet?prefix=${key}`);
                console.log(res)
                if (res.status === 200) {
                    value = await res.text();
                }
            } catch (error) {

            }
            if (!value) {
                return;
            }
            ev.preventDefault();
            textarea.setRangeText(value, start, end, "end");
        } else if (ev.key === "F8") {
            let value = await readText();
            let start = textarea.selectionStart;
            let end = textarea.selectionEnd;
            let cut = null;
            value = value.split('\n').filter((x, index) => {
                if (index === 0 && !x.trim()) return false;
                if (cut === null) {
                    cut = ' '.repeat((/^ +/.exec(x) && /^ +/.exec(x).value || '').length);
                }
                return true;
            })
                .map((x, i) => {
                    if (x.startsWith(cut)) {
                        x = x.slice(cut.length);
                    }
                    return "    " + x;
                }).join('\n');
            value = `
1.

    \`\`\`rs
${value}
    \`\`\`
`
            textarea.setRangeText(value, start, end, "end");
        }
    });
</script>


<script>
    document.addEventListener('visibilitychange', evt => {
        localStorage.setItem('content', textarea.value)
    })
    textarea.value = localStorage.getItem('content') || '';

    function launchDialog() {
        let html = `<div class="dialog-container">
      <div class="dialog">
        <div class="dialog-header">
          <h2 class="dialog-header-title">
            代码段
          </h2>
        </div>
        <div class="dialog-body">
        </div>
        <div class="dialog-buttons">
          <div class="dialog-button">
            取消
          </div>
          <div class="dialog-button" style="color: #909090;">
            继续
          </div>
        </div>
      </div>
      <div class="modern-overlay">
      </div>
    </div>`;
        const div = document.createElement('div');
        div.innerHTML = html;
        document.body.appendChild(div);


        const dialogContainer = div.querySelector('.dialog-container');
        const dialogButton = div.querySelector('.dialog-button');
        const modernOverlay = div.querySelector('.modern-overlay');
        const dialogBody = div.querySelector('.dialog-body');
        dialogButton.addEventListener('click', () => {
            div.remove();
        })
        modernOverlay.addEventListener('click', () => {
            div.remove();
        });

        async function renderDialog() {
            const res = await fetch(`/api/snippet`);
            const items = await res.json();
            items.forEach(element => {
                    let html = `<div class="dialog-item">
      <div class="dialog-item-title">
        ${element}
      </div>
      <div class="dialog-item-icon">
        <svg class="dialog-item-svg" viewBox="0 0 24 24">
          <path d="M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z">
          </path>
        </svg>
      </div>
    </div>`;
                    dialogBody.insertAdjacentHTML(
                        'afterbegin', html
                    )
                }
            );
            div.querySelectorAll('.dialog-item-icon').forEach(element => {
                element.addEventListener('click', async evt => {
                    const prefix = element.previousElementSibling.textContent.trim();
                    const res = await fetch(`/api/snippet/delete?prefix=${encodeURIComponent(prefix)}`)
                    div.remove();
                })
            })


        }

        renderDialog();


        // fetch(`/api/snippet/insert`, {
        //     method: 'post',
        //     headers: {
        //         "Content-Type": "application/json; charset=utf-8"
        //     },
        //     body: JSON.stringify({
        //         "prefix": "good",
        //         "body": "321"
        //     })
        // })
    }

    const showSnippet = document.querySelector('#show-snippet');
    showSnippet.addEventListener('click', evt => {
        launchDialog();
    });

    function launchNote() {
        let html = `<div class="dialog-container">
      <div class="dialog">
        <div class="dialog-header">
          <h2 class="dialog-header-title">
            笔记
          </h2>
        </div>
        <div class="dialog-search" >
        <div style="
color: #5f6368;
position: absolute;
top: 18px;
left: 20px;">
<svg style="fill: currentColor;" focusable="false" width="24" height="24" viewBox="0 0 24 24"><path d="M20.49 19l-5.73-5.73C15.53 12.2 16 10.91 16 9.5A6.5 6.5 0 1 0 9.5 16c1.41 0 2.7-.47 3.77-1.24L19 20.49 20.49 19zM5 9.5C5 7.01 7.01 5 9.5 5S14 7.01 14 9.5 11.99 14 9.5 14 5 11.99 5 9.5z"></path></svg>
</div>
          <div style="flex: 1; height: 100%; position: relative;">
            <input type="text" class="dialog-search-input" placeholder="搜索笔记">
          </div>
        </div>
        <div class="dialog-body">
        </div>
        <div class="dialog-buttons">
          <div class="dialog-button">
            取消
          </div>
          <div class="dialog-button" style="color: #909090;">
            继续
          </div>
        </div>
      </div>
      <div class="modern-overlay">
      </div>
    </div>`;
        const div = document.createElement('div');
        div.innerHTML = html;
        document.body.appendChild(div);


        const noteContainer = div.querySelector('.dialog-container');
        const noteButton = div.querySelector('.dialog-button');
        const modernOverlay = div.querySelector('.modern-overlay');
        const noteBody = div.querySelector('.dialog-body');
        const dialogSearchInput = div.querySelector('.dialog-search-input');
        noteButton.addEventListener('click', () => {
            div.remove();
        })
        modernOverlay.addEventListener('click', () => {
            div.remove();
        });

        dialogSearchInput.addEventListener('keydown', async evt => {
            if (evt.key === "Enter") {
                let where = 'search';
                let q = dialogSearchInput.value.trim();
                if (q.startsWith("*")) {
                    q = q.slice(1);
                    where = "like";
                }
                const res = await fetch(`/api/note/${where}?q=%${encodeURIComponent(q)}%`);
                const items = await res.json();
                noteBody.innerHTML = '';
                items.forEach(element => {
                    let html = `<div class="dialog-item" data-id="${element._id}">
      <div class="dialog-item-title">
        ${element.title}
      </div>
      <div class="dialog-item-icon">
        <svg class="dialog-item-svg" viewBox="0 0 24 24">
          <path d="M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z">
          </path>
        </svg>
      </div>
    </div>`;
                    noteBody.insertAdjacentHTML(
                        'afterbegin', html
                    )
                })
            }
            div.querySelectorAll('.dialog-item').forEach(element => {
                element.addEventListener('click', async evt => {
                    const id = element.dataset.id;
                    const res = await fetch(`/api/note?id=${id}`)
                    div.remove();
                    window.history.pushState({}, '', `?id=${id}`);
                    textarea.value = `${await res.text()}`;
                })
            });
        })

        async function renderNote() {
            const res = await fetch(`/api/note`);
            const items = await res.json();
            const buffer = [];
            items.forEach(element => {
                    let html = `<div class="dialog-item" data-id="${element._id}">
      <div class="dialog-item-title">
        ${element.title}
      </div>
      <div class="dialog-item-icon">
        <svg class="dialog-item-svg" viewBox="0 0 24 24">
          <path d="M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z">
          </path>
        </svg>
      </div>
    </div>`;
                    buffer.push(html);

                }
            );
            noteBody.innerHTML = buffer.join('');
            div.querySelectorAll('.dialog-item').forEach(element => {
                element.addEventListener('click', async evt => {
                    const id = element.dataset.id;
                    const res = await fetch(`/api/note?id=${id}`)
                    div.remove();
                    window.history.pushState({}, '', `?id=${id}`);
                    textarea.value = `${element.querySelector('.dialog-item-title').textContent.trim()}\n\n${await res.text()}`;
                })
            })

            // div.querySelectorAll('.dialog-item').forEach(element => {
            //     element.addEventListener('click', async evt => {
            //         const prefix = element.previousElementSibling.textContent.trim();
            //         const res = await fetch(`/api/snippet/delete?prefix=${encodeURIComponent(prefix)}`)
            //         div.remove();
            //     })
            // })

        }

        async function renderArticle() {
            const res = await fetch(`/api/articles`);
            const items = await res.json();
            const buffer = [];
            items.forEach(element => {
                    let html = `<div class="dialog-item" data-id="${element.id}">
      <div class="dialog-item-title">
        ${element.title}
      </div>
      <div class="dialog-item-icon">
        <svg class="dialog-item-svg" viewBox="0 0 24 24">
          <path d="M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z">
          </path>
        </svg>
      </div>
    </div>`;
                    buffer.push(html);

                }
            );
            noteBody.innerHTML = buffer.join('');
            div.querySelectorAll('.dialog-item').forEach(element => {
                element.addEventListener('click', async evt => {
                    const id = element.dataset.id;
                    const res = await fetch(`/api/article?article=${id}`)
                    div.remove();
                    window.history.pushState({}, '', `?article=${id}`);
                    const obj = await res.json();
                    textarea.value = `${obj.title}|${JSON.stringify(obj.tags)}\n\n${obj.content}\n`;
                })
            })

        }

        function renderData() {
            const searchParams = new URL(window.location).searchParams;
            if (searchParams.has("article")) {
                renderArticle();
            } else {
                renderNote();
            }
        }

        renderData();
        // fetch(`/api/snippet/insert`, {
        //     method: 'post',
        //     headers: {
        //         "Content-Type": "application/json; charset=utf-8"
        //     },
        //     body: JSON.stringify({
        //         "prefix": "good",
        //         "body": "321"
        //     })
        // })
    }

    //launchNote();
    const showNote = document.querySelector('#show-note');
    showNote.addEventListener('click', evt => {
        launchNote();
    });

    document.querySelector('#format-upload').addEventListener('click', evt => {
        uploadHanlder(textarea);
    })

    function getPatterns() {
        let strings;

        strings = localStorage.getItem('pattern')
        return strings;
    }

    function setPatterns(patterns) {
        localStorage.setItem('pattern', patterns)
    }

    function onShowDialog() {
        const customDialog = document.createElement('custom-dialog');
        document.body.appendChild(customDialog);
        customDialog.title = ""
        window.customDialog = customDialog;
        customDialog.addEventListener('submit', evt => {
            setPatterns(customDialog.content);
        });
        const patterns = getPatterns();
        if (patterns) {
            customDialog.content = patterns;
        }
        //customDialog.style.display = 'none';
    }

    document.getElementById('show-patterns').addEventListener('click', evt => {
        onShowDialog()
    })
    document.getElementById('format-cut-before').addEventListener('click', evt => {
        cutBefore();
    })
    document.getElementById('format-paste-end').addEventListener('click', evt => {
        pasteEnd();
    })
</script>
<script>
    class CustomToast extends HTMLElement {
        static get observedAttributes() {
            return ['message'];
        }

        // Fires when an instance of the element is created or updated
        constructor() {
            super();
            this.root = this.attachShadow({
                mode: 'open'
            });
            const style = document.createElement('style');
            style.textContent = CustomToast.getStyle();
            this.root.appendChild(style);
            const c3Toast = document.createElement('DIV');
            c3Toast.setAttribute('class', 'c3-toast');

            const notificationActionRenderer = document.createElement('DIV');
            notificationActionRenderer.setAttribute('class', 'notification-action-renderer');
            const notificationActionResponseText = document.createElement('DIV');
            notificationActionResponseText.setAttribute('class', 'notification-action-response-text');
            notificationActionRenderer.appendChild(notificationActionResponseText);
            c3Toast.appendChild(notificationActionRenderer);
            this.root.appendChild(c3Toast);

            this.c3Toast = c3Toast;
            this.notificationActionResponseText = notificationActionResponseText;
            this.messages = [];
            this.timer = 0;
        }

        // Fires when an instance was inserted into the document
        connectedCallback() {
        }

        // Fires when an instance was removed from the document
        disconnectedCallback() {
        }

        showMessage() {
            if (this.messages.length && !this.showing) {
                const message = this.messages.shift();
                this.notificationActionResponseText.textContent = message;
                this.c3Toast.setAttribute('dir', 'in');
                this.showing = true;
                if (this.timer) {
                    clearTimeout(this.timer);
                }
                this.timer = setTimeout(() => {
                    this.c3Toast.setAttribute('dir', 'out');
                    setTimeout(() => {
                        this.showing = false;
                        this.showMessage();
                    }, 195);
                }, 3000);
            }
        }

        // Fires when an attribute was added, removed, or updated
        attributeChangedCallback(attrName, oldVal, newVal) {
            if (attrName === 'message') {
                this.messages.push(newVal);
                this.showMessage();
            }
        }

        // Fires when an element is moved to a new document
        adoptedCallback() {
        }

        static getTemplate(value) {
            return `
        ${CustomToast.getStyle()}
        <div>
            ${value}
        </div>
        `;
        }

        static getStyle() {
            return `
        .c3-toast[dir="in"] {
            transition: margin 225ms cubic-bezier(0.0, 0.0, 0.2, 1);
            margin-top: 0;
        }

        .c3-toast[dir="out"] {
            transition: margin 195ms cubic-bezier(0.4, 0.0, 1, 1);
        }

        .c3-toast {
            display: block;
            position: fixed;
            z-index: 999;
            left: 0;
            right: 0;
            top: 0;
            box-sizing: border-box;
            padding: 14px 24px;
            font-size: 1.4rem;
            color: #ffffff;
            background: hsl(0, 0%, 20%);
            will-change: transform;
            margin-top: -100%;
        }

        .notification-action-renderer {
            display: flex;
            align-items: center;
        }

        .notification-action-response-text {
            flex-grow: 1;
            padding-right: 1rem;
            font-size:14px;
        }

        `;
        }
    }

    customElements.define('custom-toast', CustomToast);
</script>
<script>
    (() => {

        class CustomDialog extends HTMLElement {

            constructor() {
                super();
                this.attachShadow({
                    mode: 'open'
                });
                const wrapper = document.createElement("div");
                wrapper.setAttribute("class", "wrapper");
                const style = document.createElement('style');
                style.textContent = `.wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  -webkit-box-align: center;
  align-items: center;
  -webkit-box-pack: center;
  justify-content: center;
  z-index: 4;
  margin: 0 40px;
  padding: 0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

.dialog {
  position: relative;
  z-index: 2;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  flex-direction: column;
  max-height: 100%;
  box-sizing: border-box;
  padding: 16px;
  margin: 0 auto;
  overflow-x: hidden;
  overflow-y: auto;
  font-size: 13px;
  color: #0f0f0f;
  border: none;
  min-width: 250px;
  max-width: 356px;
  box-shadow: 0 0 24px 12px rgba(0, 0, 0, 0.25);
  border-radius: 12px;
  background-color: #fff;
}

.dialog-header {
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  flex-direction: column;
  flex-shrink: 0;
}

.h2 {
  margin: 0 0 3px;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  max-height: 2.5em;
  -webkit-line-clamp: 2;
  overflow: hidden;
  line-height: 1.25;
  text-overflow: ellipsis;
  font-weight: normal;
  font-size: 18px;
}

.dialog-body {
  overflow-y: auto;
  overflow-x: hidden;
  max-height: 100vh;
}

.dialog-buttons {
  display: flex;
  -webkit-box-align: center;
  align-items: center;
  -webkit-box-pack: end;
  justify-content: flex-end;
  margin-top: 12px;
}

.button {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 16px;
  height: 36px;
  font-size: 14px;
  line-height: 36px;
  border-radius: 18px;
  color: #0f0f0f;
}

.disabled {
  color: #909090
}

.overlay {
  position: fixed;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1;
  cursor: pointer;
  background-color: rgba(0, 0, 0, 0.3);
}

input,
textarea {
  background-color: transparent;
  padding-bottom: 4px;
  outline: none;
  box-sizing: border-box;
  border: none;
  border-radius: 0;
  margin-bottom: 1px;
  font: inherit;
  color: #0f0f0f
}

textarea {
  -webkit-appearance: none;
  appearance: none;
  min-height: 8.4rem;
  width: 100%;
  border: 1px solid rgba(0, 0, 0, 0.1);
  padding: 8px
}`;
                this.wrapper = wrapper;
                this.shadowRoot.append(style, wrapper);
            }

            static get observedAttributes() {
                return ['title'];
            }

            set title(name) {
                this._title.textContent = name;
            }

            set content(value) {
                this.textarea.value = value;
            }

            get content() {
                return this.textarea.value;
            }

            navigate(e) {
                this.dispatchEvent(new CustomEvent('submit', {
                    detail: e.currentTarget.dataset.href
                }));
                this.remove();
            }

            _close(evt) {
                evt.stopPropagation();
                this.remove();
            }

            _submit(evt) {
                evt.stopPropagation();
                this.remove();
                this.dispatchEvent(new CustomEvent('submit', {
                    detail: this.textarea.value
                }));
            }

            connectedCallback() {
                this.wrapper.innerHTML = `<div class="dialog">
  <div class="dialog-header">
    <h2 bind="_title" class="h2">${this.getAttribute("title")}</h2>
  </div>
  <div bind="_message" class="dialog-body">
    <textarea bind="textarea"></textarea>
  </div>
  <div class="dialog-buttons">
    <div bind class="button" @click="_close">
      取消
    </div>
    <div bind class="button disabled" @click="_submit">
      确定
    </div>
  </div>
</div>
<div bind class="overlay" @click="_close">
</div>`;
                this.wrapper.querySelectorAll('[bind]').forEach(element => {
                    if (element.getAttribute('bind')) {
                        this[element.getAttribute('bind')] = element;
                    }
                    [...element.attributes].filter(attr => attr.nodeName.startsWith('@')).forEach(attr => {
                        if (!attr.value) return;
                        element.addEventListener(attr.nodeName.slice(1), evt => {
                            this[attr.value](evt);
                        });
                    });
                })
            }

            attributeChangedCallback(name, oldValue, newValue) {
            }
        }

        customElements.define('custom-dialog', CustomDialog);


    })();
</script>
<custom-toast id="toast"></custom-toast>
</body>

</html>